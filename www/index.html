<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src * data:; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
  <script src="components/loader.js"></script>
  <script src="lib/onsenui/js/onsenui.min.js"></script>

  <link rel="stylesheet" href="components/loader.css">
  <link rel="stylesheet" href="lib/onsenui/css/onsenui.css">
  <link rel="stylesheet" href="lib/onsenui/css/onsen-css-components.css">
  <link rel="stylesheet" href="css/style.css">

  <script>

  document.onclick = function (e) {
    e = e ||  window.event;
    var element = e.target || e.srcElement;
    if (element.tagName == 'a') {
      window.open(element.href, "_blank", "location=yes");
      return false;
    }
  };

  function openLink(link) {
    window.open(link, "_blank", "location=yes");
    return false;
  }

  var textOnlyMode = false;

  function textOnlyModeChoice(arg) {
    document.getElementById("alert-text-only-dialog").hide();
    if (arg === 'true') {
      textOnlyMode = true;
      startHome();
    } else {
      textOnlyMode = false;
      startHome();
    }
  }

  /* Load the home page function */
  function startHome() {
    console.log("startHome() started." + " textOnlyMode = " + textOnlyMode);
    var articlesList = document.querySelector('#article-list');
    var startResults = 0;
    var articleLiArr = [];

    function getArticles() {

      var request = new XMLHttpRequest();

      request.open('POST', 'http://drydenwire.com/api/json-news');
      request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      request.send("startResults=" + startResults);
      request.onreadystatechange = function () {
        var DONE = this.DONE;

        if (this.readyState === DONE) {
          var json = JSON.parse(request.responseText);//
          console.log(json);

          //If this is the featured article (It is pushed to 0 index of array)
          if (startResults === 0) {

            if (textOnlyMode === true) {
              //create featured wrapper
              var featuredWrapper = document.createElement("div");
              featuredWrapper.setAttribute("id", "featured-wrapper-textonlymode");
              featuredWrapper.setAttribute("data-pageid", json[0].pageid);
              //create featured heading
              var featuredHeading = document.createElement("h3");
              featuredHeading.setAttribute("id", "featured-heading-textonlymode");
              featuredHeading.innerHTML = json[0].title;
              //append everything to page
              featuredWrapper.appendChild(featuredHeading);
              document.querySelector("#article-list").appendChild(featuredWrapper);
            } else {
              //create featured wrapper
              var featuredWrapper = document.createElement("div");
              featuredWrapper.setAttribute("id", "featured-wrapper");
              featuredWrapper.setAttribute("data-pageid", json[0].pageid);
              //create featured heading
              var featuredHeading = document.createElement("h3");
              featuredHeading.setAttribute("id", "featured-heading");
              featuredHeading.setAttribute("class", "featured-heading-textonlymode");
              featuredHeading.innerHTML = json[0].title;
              //create featured image
              var featuredImage = document.createElement("img");
              featuredImage.setAttribute("src", json[0].latestImgUrl);
              featuredImage.setAttribute("id", "featured-image");
              //append everything to page
              featuredWrapper.appendChild(featuredImage);
              featuredWrapper.appendChild(featuredHeading);
              document.querySelector("#article-list").appendChild(featuredWrapper);
            }
          }

          for (i=1;i<Object.keys(json).length;i++) {
            if (json[i].ad === true) {
              //create card
              var card = document.createElement("div");
              card.setAttribute("class", "ad-card");
              //create flexbox
              var flexbox = document.createElement("div");
              flexbox.setAttribute("class", "flexbox");

              if (textOnlyMode === false) {
                //create thumbnail
                var img = document.createElement("img");
                img.setAttribute("src", json[i].adSrc);//
                img.setAttribute("onclick", "openLink(\"" + json[i].adLink + "\")");
              }
              //create card footer
              var footer = document.createElement("div");
              footer.setAttribute("class", "ad-card-footer");
              footer.innerHTML = "<small><ons-icon icon=\"external-link\"></ons-icon> " + json[i].adLink + "</small>";
              //remove spinner
              document.querySelector("#article-list-spinner").style.display = "none";
              //append content
              card.appendChild(flexbox);
              if (textOnlyMode === false) {
                flexbox.appendChild(img);
              }
              card.appendChild(footer);
              document.querySelector("#article-list").appendChild(card);//

            } else {
              //create card//
              var card = document.createElement("div");
              card.setAttribute("class", "article-card");
              card.setAttribute("data-pageid", json[i].pageid)
              //create flexbox
              var flexbox = document.createElement("div");
              flexbox.setAttribute("class", "flexbox");

              if (textOnlyMode === false) {
                //create thumbnail
                var img = document.createElement("img");
                img.setAttribute("src", json[i].thumbUrl);
              }
              //create title
              var title = document.createElement("p");//
              title.innerHTML = json[i].title;
              //create card footer
              var footer = document.createElement("div");
              footer.setAttribute("class", "article-card-footer");
              footer.innerHTML = "<small><ons-icon icon=\"user\"></ons-icon> By " + json[i].author + "</small><small><ons-icon icon=\"calendar\"></ons-icon> " + json[i].date + "</small>";
              //remove spinner
              document.querySelector("#article-list-spinner").style.display = "none";
              //append content
              card.appendChild(flexbox);
              if (textOnlyMode === false) {
                flexbox.appendChild(img);
              }
              flexbox.appendChild(title);
              card.appendChild(footer);
              document.querySelector("#article-list").appendChild(card);
            }

            //update the next starting point for pulling articles
            startResults += 1;
          }

          addEventHandlersToArticles();
        }
      }

    }

    //initially load articles
    getArticles();

    //event handler to load more articles with button
    document.querySelector('#articles-load').onclick = function() {
      getArticles();
    };

    function addEventHandlersToArticles() {
      var articles = document.getElementsByClassName("article-card");
      if (textOnlyMode === true) {
        var featuredArticle = document.getElementById("featured-wrapper-textonlymode");
      } else {
        var featuredArticle = document.getElementById("featured-wrapper");
      }

      featuredArticle.addEventListener("click", function() {
        openArticle(this.dataset.pageid);
      })

      for (var i=0;i<articles.length;i++) {
        articles[i].addEventListener("click", function() {
          openArticle(this.dataset.pageid);
        })
      }

    }

    //function to open article
    function openArticle(id, textOnly) {
        var json;
        document.querySelector('#navigator')
        .pushPage("article.html", {data: {
          pageid: id
        }})
        .then(function(page) {
          //console.log("Page Name: ", page.name);//

          var request = new XMLHttpRequest();

          request.open('POST', 'http://drydenwire.com/api/json-news');
          request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
          request.send("articleId=" + page.data.pageid);
          request.onreadystatechange = function () {
            var DONE = this.DONE;//

            if (this.readyState === DONE) {
                var json = JSON.parse(request.responseText);
                //console.log("Response Text: " + request.responseText);

                //remove spinner
                document.querySelector("#single-article-spinner").style.display = "none";

                //date for title
                document.querySelector('#article-heading').innerHTML = json.date;

                //find the wrapper
                var wrapper = document.querySelector('#article-wrapper');

                console.log("Text only mode: " + textOnlyMode);

                if (textOnlyMode === false) {
                  //create image
                  var img = document.createElement("img");
                  img.setAttribute("src", json.imgUrl);
                }

                //create title
                var titleWrapper = document.createElement("div");
                titleWrapper.setAttribute("class", "article-title-wrapper");
                var title = document.createElement("h3");
                title.innerHTML = json.title;
                titleWrapper.appendChild(title);

                //create body
                var bodyWrapper = document.createElement("div");
                bodyWrapper.setAttribute("id", "article-body-wrapper");
                bodyWrapper.innerHTML = json.body;

                if (textOnlyMode === false) {
                  wrapper.appendChild(img);
                }
                wrapper.appendChild(titleWrapper);
                wrapper.appendChild(bodyWrapper);

              } //end if done
            } //end on ready state change
          }) // End then
        } // End open article function
  }
  /* End Load Home Page Function */

  document.addEventListener('init', function(event) {
    var page = event.target;

    if (event.target.matches("#home")) {

      /* Test Connection */
      //JUST AN EXAMPLE, PLEASE USE YOUR OWN PICTURE!
      var imageAddr = "http://drydenwire.com/site/assets/files/2665/speedtestimage.jpg";
      var downloadSize = 27000; //bytes

      function ShowProgressMessage(msg) {
          if (console) {
              if (typeof msg == "string") {
                  console.log(msg);
              } else {
                  for (var i = 0; i < msg.length; i++) {
                      console.log(msg[i]);
                  }
              }
          }

          var oProgress = document.getElementById("progress");
          if (oProgress) {
              var actualHTML = (typeof msg == "string") ? msg : msg.join("<br />");
              oProgress.innerHTML = actualHTML;
          }
      }

      function InitiateSpeedDetection() {
          ShowProgressMessage("Loading the image, please wait...");
          window.setTimeout(MeasureConnectionSpeed, 1);
      };

      if (window.addEventListener) {
          window.addEventListener('load', InitiateSpeedDetection, false);
      } else if (window.attachEvent) {
          window.attachEvent('onload', InitiateSpeedDetection);
      }

      function MeasureConnectionSpeed() {
          var startTime, endTime;
          var download = new Image();
          download.onload = function () {
              endTime = (new Date()).getTime();
              showResults();
              var duration = (endTime - startTime) / 1000;
              var bitsLoaded = downloadSize * 8;
              var speedBps = (bitsLoaded / duration).toFixed(2);
              var speedKbps = (speedBps / 1024).toFixed(2);
              if (speedKbps < 500) {
                document.getElementById("alert-text-only-dialog").show();
              } else {
                startHome();
              }
          }

          download.onerror = function (err, msg) {
              ShowProgressMessage("Invalid image, or error downloading");
          }

          startTime = (new Date()).getTime();
          var cacheBuster = "?nnn=" + startTime;
          download.src = imageAddr + cacheBuster;

          function showResults() {
              var duration = (endTime - startTime) / 1000;
              var bitsLoaded = downloadSize * 8;
              var speedBps = (bitsLoaded / duration).toFixed(2);
              var speedKbps = (speedBps / 1024).toFixed(2);
              var speedMbps = (speedKbps / 1024).toFixed(2);
              ShowProgressMessage([
                  "Your connection speed is:",
                  speedBps + " bps",
                  speedKbps + " kbps",
                  speedMbps + " Mbps"
              ]);
          }
      }

      MeasureConnectionSpeed();


    } //End if is home

  }); //End on document init



  </script>
</head>
<body>

  <ons-navigator animation="slide" id="navigator" page="home.html">
  </ons-navigator>

  <ons-alert-dialog id="alert-text-only-dialog">
    <div class="alert-dialog-title">Warning!</div>
    <div class="alert-dialog-content">
      Your connection is less than 500kbps. Would you like to enable text-only mode?
    </div>
    <div class="alert-dialog-footer">
      <button class="alert-dialog-button" onclick="textOnlyModeChoice('true')">Yes</button>
      <button class="alert-dialog-button" onclick="textOnlyModeChoice('false')">No</button>
    </div>
  </ons-alert-dialog>

  <ons-template id="home.html">
    <ons-page id="home">
      <ons-toolbar>
        <div class="center">
          Home
        </div>
      </ons-toolbar>

      <div id="article-list">
        <span id="article-list-spinner" class="spinner">
          <ons-icon size="35px" spin="true" icon="ion-load-d"></ons-icon>
        </span>
      </div>
      <p id="load-more-wrapper">
        <ons-button modifier="large--cta" id="articles-load">Load More</ons-button>
      </p>
    </ons-page>
  </ons-template>

  <ons-template id="article.html" >
    <ons-page>
      <ons-toolbar>
        <div class="left">
          <ons-back-button>Back</ons-back-button>
        </div>
        <div id="article-heading" class="center"></div>
      </ons-toolbar>
      <div id="article-wrapper">
        <span id="single-article-spinner" class="spinner">
          <ons-icon size="35px" spin="true" icon="ion-load-d"></ons-icon>
        </span>
      </div>
    </ons-page>
  </ons-template>

  <ons-template id="obituaries.html">
  <ons-page>
    <ons-toolbar>
      <div class="center">
        Obituaries
      </div>
    </ons-toolbar>
    OBITUARIES ARE SO NICE
  </ons-page>
  </ons-template>

  <ons-template id="headlines.html">
  <ons-page>
    <ons-toolbar>
      <div class="center">
        Headlines
      </div>
    </ons-toolbar>
  </ons-page>
  </ons-template>

    <ons-template id="advertise.html">
  <ons-page>
    <ons-toolbar>
      <div class="center">
        Advertise
      </div>
    </ons-toolbar>
  </ons-page>
  </ons-template>

<!--
  <ons-tabbar>
    <ons-tab label="home" page="home.html" icon="home" active>
    </ons-tab>
    <ons-tab label="obituaries" page="obituaries.html" icon="bank">
    </ons-tab>
    <ons-tab label="headlines" page="headlines.html" icon="list">
    </ons-tab>
    <ons-tab label="advertise" page="advertise.html" icon="usd">
    </ons-tab>
  </ons-tabbar>
-->
</body>
</html>
